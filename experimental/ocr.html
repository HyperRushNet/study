<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OCR AI Demo (All Visible Text)</title>
</head>
<body>
  <h2>OCR AI Demo</h2>

  <input type="file" id="imageInput" accept="image/*"><br>
  <button id="scanBtn">Scan Image</button>

  <h3>OCR Output:</h3>
  <div id="output" style="white-space: pre-wrap; border:1px solid #ccc; padding:10px; max-width:600px;"></div>

  <script>
  // ================= OCR LIBRARY =================
  (function(global) {
    /**
     * scanForText(base64Image)
     * Returns a Promise resolving to plain text of the exact AI OCR output
     */
    global.scanForText = async function(base64Image) {
      if (!base64Image) throw new Error("No base64 image provided");

      const systemPrompt = {
        role: "system",
        content:
          "You are an OCR AI. Extract **absolutely every visible character** from the image. " +
          "This includes main text, small text, watermarks, disclaimers, labels, metadata, numbers, and anything readable. " +
          "Never skip faint, small, rotated, or partial text. " +
          "Preserve line breaks, spacing, punctuation, and symbols exactly as seen. " +
          "Do not rewrite, fix, correct, or explain. " +
          "Do not add prefixes like 'Extracted text:'. " +
          "If and only if there is truly no text at all, output exactly: No text detected in image. " +
          "Otherwise, output only the raw transcription of everything visible."
      };

      const userMessage = {
        role: "user",
        content: [
          { type: "text", text: "Extract all visible text from this image, including the smallest details, and output only the raw text:" },
          { type: "image_url", image_url: { url: `data:image/png;base64,${base64Image}` } }
        ]
      };

      try {
        const response = await fetch("https://text.pollinations.ai/openai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "openai",
            messages: [systemPrompt, userMessage]
          })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        return data.choices?.[0]?.message?.content?.trim() || "No text detected in image.";
      } catch(err) {
        return "Error: " + err.message;
      }
    };
  })(window);

  // ================= UI HANDLING =================
  const imageInput = document.getElementById("imageInput");
  const scanBtn = document.getElementById("scanBtn");
  const outputDiv = document.getElementById("output");

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  scanBtn.addEventListener("click", async () => {
    const file = imageInput.files[0];
    if (!file) return alert("Please upload an image.");

    outputDiv.textContent = "Processingâ€¦";

    try {
      const base64Image = await fileToBase64(file);
      const aiText = await scanForText(base64Image);
      outputDiv.textContent = aiText;
    } catch (err) {
      outputDiv.textContent = "Error: " + err;
    }
  });
  </script>
</body>
</html>
